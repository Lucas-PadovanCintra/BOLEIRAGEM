<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 fw-bold text-dark mb-1">Relat√≥rio Financeiro</h1>
      <p class="text-muted mb-0">Acompanhe todos os seus ganhos e perdas</p>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card border-success">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted small mb-1">Receitas</p>
              <h3 class="fw-bold text-success mb-0">
                <i class="fas fa-arrow-up small"></i>
                <%= number_with_delimiter(@stats[:total_income]) %>
              </h3>
              <small class="text-muted"><%= @period_label %></small>
            </div>
            <i class="fas fa-chart-line text-success opacity-25" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-danger">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted small mb-1">Despesas</p>
              <h3 class="fw-bold text-danger mb-0">
                <i class="fas fa-arrow-down small"></i>
                <%= number_with_delimiter(@stats[:total_expense]) %>
              </h3>
              <small class="text-muted"><%= @period_label %></small>
            </div>
            <i class="fas fa-shopping-cart text-danger opacity-25" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-<%= @stats[:net_result] >= 0 ? 'primary' : 'warning' %>">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted small mb-1">Resultado L√≠quido</p>
              <h3 class="fw-bold text-<%= @stats[:net_result] >= 0 ? 'primary' : 'warning' %> mb-0">
                <%= @stats[:net_result] >= 0 ? '+' : '-' %><%= number_with_delimiter(@stats[:net_result].abs) %>
              </h3>
              <small class="text-muted"><%= @period_label %></small>
            </div>
            <i class="fas fa-balance-scale text-<%= @stats[:net_result] >= 0 ? 'primary' : 'warning' %> opacity-25" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-info">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-muted small mb-1">Saldo Atual</p>
              <h3 class="fw-bold text-info mb-0">
                üí∞ <%= number_with_delimiter(@wallet.balance) %>
              </h3>
              <small class="text-muted">Em carteira</small>
            </div>
            <i class="fas fa-coins text-info opacity-25" style="font-size: 2rem;"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" action="<%= financial_report_wallet_path(@wallet) %>" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small text-muted">Per√≠odo</label>
          <%= select_tag :period,
              options_for_select([
                ['Todos', 'all'],
                ['Hoje', 'today'],
                ['Esta Semana', 'week'],
                ['Este M√™s', 'month']
              ], @period),
              class: "form-select" %>
        </div>

        <div class="col-md-3">
          <label class="form-label small text-muted">Categoria</label>
          <%= select_tag :category,
              options_for_select([
                ['Todas', ''],
                ['Partidas', 'match'],
                ['Jogadores', 'player'],
                ['Administrativo', 'admin'],
                ['B√¥nus', 'bonus']
              ], @category),
              class: "form-select" %>
        </div>

        <div class="col-md-3">
          <label class="form-label small text-muted">Tipo</label>
          <%= select_tag :type,
              options_for_select([
                ['Todos', ''],
                ['Recompensa de Partida', 'match_reward'],
                ['Penalidade de Partida', 'match_penalty'],
                ['Compra de Jogador', 'player_purchase'],
                ['Venda de Jogador', 'player_sale'],
                ['Contrato Expirado', 'contract_expire'],
                ['Saldo Inicial', 'initial_balance']
              ], @type),
              class: "form-select" %>
        </div>

        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-filter me-2"></i>Filtrar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-4">
    <!-- Transactions List -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 fw-bold">Hist√≥rico de Transa√ß√µes</h5>
        </div>
        <div class="card-body p-0">
          <% if @transactions.any? %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40px;"></th>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th class="text-end">Valor</th>
                    <th class="text-end">Saldo Ap√≥s</th>
                    <th>Data</th>
                  </tr>
                </thead>
                <tbody>
                  <% @transactions.each do |transaction| %>
                    <tr>
                      <td class="text-center">
                        <i class="fas <%= transaction.icon %>"></i>
                      </td>
                      <td>
                        <div class="fw-medium"><%= transaction.description || transaction.type_label %></div>
                        <% if transaction.match %>
                          <small class="text-muted">Partida #<%= transaction.match.id %></small>
                        <% elsif transaction.player %>
                          <small class="text-muted"><%= transaction.player.name %></small>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-secondary"><%= transaction.category_label %></span>
                      </td>
                      <td class="text-end fw-bold text-<%= transaction.income? ? 'success' : 'danger' %>">
                        <%= transaction.income? ? '+' : '-' %><%= number_with_delimiter(transaction.amount.abs) %>
                      </td>
                      <td class="text-end">
                        <%= number_with_delimiter(transaction.balance_after || '-') %>
                      </td>
                      <td class="text-muted">
                        <%= transaction.created_at.strftime("%d/%m/%Y %H:%M") %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="card-footer bg-white">
              <%= will_paginate @transactions, class: "pagination justify-content-center" %>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-receipt text-muted" style="font-size: 3rem;"></i>
              <p class="mt-3 text-muted">Nenhuma transa√ß√£o encontrada para os filtros selecionados.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Charts and Additional Info -->
    <div class="col-lg-4">
      <!-- Quick Stats -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Estat√≠sticas do Per√≠odo</h6>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Transa√ß√µes:</span>
            <span class="fw-bold"><%= @stats[:transaction_count] %></span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">M√©dia de Receitas:</span>
            <span class="fw-bold text-success">+<%= number_with_delimiter(@stats[:avg_income].round) %></span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">M√©dia de Despesas:</span>
            <span class="fw-bold text-danger">-<%= number_with_delimiter(@stats[:avg_expense].round) %></span>
          </div>

          <hr>

          <% if @stats[:net_result] >= 0 %>
            <div class="alert alert-success mb-0">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Lucro!</strong> Voc√™ est√° <%= number_with_delimiter(@stats[:net_result]) %> positivo <%= @period_label.downcase %>.
            </div>
          <% else %>
            <div class="alert alert-warning mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Aten√ß√£o!</strong> Voc√™ est√° <%= number_with_delimiter(@stats[:net_result].abs) %> negativo <%= @period_label.downcase %>.
            </div>
          <% end %>
        </div>
      </div>

      <!-- Category Distribution -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Distribui√ß√£o por Categoria</h6>
          <% if @chart_data[:categories].any? %>
            <div style="height: 250px; position: relative;">
              <canvas id="categoryChart"></canvas>
            </div>
          <% else %>
            <p class="text-muted small">Sem dados para exibir</p>
          <% end %>
        </div>
      </div>

      <!-- Balance Evolution -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="fw-bold mb-3">Evolu√ß√£o do Saldo (30 dias)</h6>
          <% if @chart_data[:balance_evolution].any? %>
            <div style="height: 250px; position: relative;">
              <canvas id="balanceChart"></canvas>
            </div>
          <% else %>
            <p class="text-muted small">Sem dados para exibir</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  <% if @chart_data[:categories].any? %>
    // Category Distribution Chart
    var ctxCategory = document.getElementById('categoryChart').getContext('2d');
    var categoryChart = new Chart(ctxCategory, {
      type: 'pie',
      data: {
        labels: <%= @chart_data[:categories].map { |c| c[:category] }.to_json.html_safe %>,
        datasets: [{
          data: <%= @chart_data[:categories].map { |c| c[:amount] }.to_json.html_safe %>,
          backgroundColor: [
            '#28a745',
            '#ffc107',
            '#17a2b8',
            '#6c757d'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              padding: 10
            }
          }
        }
      }
    });
  <% end %>

  <% if @chart_data[:balance_evolution].any? %>
    // Balance Evolution Chart
    var ctxBalance = document.getElementById('balanceChart').getContext('2d');
    var balanceChart = new Chart(ctxBalance, {
      type: 'line',
      data: {
        labels: <%= @chart_data[:balance_evolution].map { |b| b[:date] }.to_json.html_safe %>,
        datasets: [{
          label: 'Saldo',
          data: <%= @chart_data[:balance_evolution].map { |b| b[:balance] }.to_json.html_safe %>,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0, 123, 255, 0.1)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              maxTicksLimit: 7
            }
          },
          y: {
            beginAtZero: false,
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          }
        },
        elements: {
          point: {
            radius: 3,
            hoverRadius: 6
          }
        }
      }
    });
  <% end %>
});
</script>